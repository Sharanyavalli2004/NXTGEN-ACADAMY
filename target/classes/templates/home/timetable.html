<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Timetable</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
<div class="flex h-screen">
  <!-- Sidebar -->
  <aside class="w-64 bg-white shadow-md overflow-y-auto">
    <div class="p-6 text-2xl font-bold text-indigo-600">Teacher Panel</div>
    <nav class="mt-6">
      <ul class="space-y-2 text-gray-700">
        <li><a href="/teacher/dashboard" class="block px-6 py-2 hover:bg-indigo-100 rounded">Dashboard</a></li>
        <li><a href="/teacher/profile" class="block px-6 py-2 hover:bg-indigo-100 rounded">Profile Setup</a></li>
        <li><a href="/teacher/attendence" class="block px-6 py-2 hover:bg-indigo-100 rounded">Attendence</a></li>
        <li><a href="/teacher/timetable" class="block px-6 py-2 bg-indigo-100 rounded font-semibold text-indigo-700">Timetable</a></li>
        <li><a href="/teacher/examinations" class="block px-6 py-2 hover:bg-indigo-100 rounded">Examinations</a></li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-8 overflow-y-auto">
    <section class="mb-10">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex justify-between">
        <span>Timetable</span>
      </h2>
      <p class="mb-4">View your weekly schedule here.</p>

      <div class="overflow-x-auto">
        <table id="gridTimetable" class="min-w-full bg-white border border-collapse">
          <thead class="bg-gray-100">
            <tr>
              <th class="border px-4 py-2">Time</th>
              <th class="border px-4 py-2">Monday</th>
              <th class="border px-4 py-2">Tuesday</th>
              <th class="border px-4 py-2">Wednesday</th>
              <th class="border px-4 py-2">Thursday</th>
              <th class="border px-4 py-2">Friday</th>
              <th class="border px-4 py-2">Saturday</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dynamic rows loaded via JS -->
          </tbody>
        </table>

        <!-- Buttons -->
        <div class="flex justify-end mt-4 space-x-2">
          <button onclick="addGridRow()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Add Row</button>
          <button onclick="editTimetable()" id="editBtn" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">Edit Timetable</button>
          <button onclick="saveTimetable()" id="saveBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 hidden">Save Timetable</button>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  let isEditing = false;

  function addGridRow() {
    if (!isEditing) return;
    const tbody = document.querySelector("#gridTimetable tbody");
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="border px-4 py-2"><input type="text" placeholder="Time Slot" class="border rounded px-2 py-1 w-full"></td>
      <td class="border px-4 py-2"><input type="text" placeholder="Monday" class="border rounded px-2 py-1 w-full"></td>
      <td class="border px-4 py-2"><input type="text" placeholder="Tuesday" class="border rounded px-2 py-1 w-full"></td>
      <td class="border px-4 py-2"><input type="text" placeholder="Wednesday" class="border rounded px-2 py-1 w-full"></td>
      <td class="border px-4 py-2"><input type="text" placeholder="Thursday" class="border rounded px-2 py-1 w-full"></td>
      <td class="border px-4 py-2"><input type="text" placeholder="Friday" class="border rounded px-2 py-1 w-full"></td>
      <td class="border px-4 py-2"><input type="text" placeholder="Saturday" class="border rounded px-2 py-1 w-full"></td>
      <td class="border px-4 py-2 text-center action-col">
        <button onclick="deleteRow(this)" class="text-red-600 font-bold">Delete</button>
      </td>`;
    tbody.appendChild(row);
  }

  function deleteRow(button) {
    button.closest("tr").remove();
  }

  function editTimetable() {
    isEditing = true;
    const headerRow = document.querySelector("#gridTimetable thead tr");
    if (!headerRow.querySelector(".action-col")) {
      const th = document.createElement("th");
      th.className = "border px-4 py-2 action-col";
      th.textContent = "Action";
      headerRow.appendChild(th);
    }

    const rows = document.querySelectorAll("#gridTimetable tbody tr");
    rows.forEach(row => {
      const cells = row.querySelectorAll("td");
      for (let i = 0; i < 7; i++) {
        const text = cells[i].textContent.trim();
        cells[i].innerHTML = `<input type="text" value="${text}" class="border rounded px-2 py-1 w-full" />`;
      }
      if (!row.querySelector(".action-col")) {
        const td = document.createElement("td");
        td.className = "border px-4 py-2 text-center action-col";
        td.innerHTML = `<button onclick="deleteRow(this)" class="text-red-600 font-bold">Delete</button>`;
        row.appendChild(td);
      }
    });

    document.getElementById("editBtn").classList.add("hidden");
    document.getElementById("saveBtn").classList.remove("hidden");
  }

  function saveTimetable() {
    const rows = document.querySelectorAll("#gridTimetable tbody tr");
    const data = Array.from(rows).map(row => {
      const cells = row.querySelectorAll("td");
      const getValue = (cell) => cell.querySelector("input")?.value.trim() || "";
      return {
        time: getValue(cells[0]),
        monday: getValue(cells[1]),
        tuesday: getValue(cells[2]),
        wednesday: getValue(cells[3]),
        thursday: getValue(cells[4]),
        friday: getValue(cells[5]),
        saturday: getValue(cells[6])
      };
    });

    fetch("/teacher/saveTimetable", {
      method: "POST",
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    }).then(res => {
      if (res.ok) {
        alert("Timetable saved successfully!");
        location.reload(); // reload to reflect saved data
      } else {
        alert("Failed to save timetable.");
      }
    }).catch(err => {
      alert("Error: " + err.message);
    });
  }

  // âœ… Load saved timetable on page load
  window.onload = function () {
    fetch("/teacher/getTimetable")
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector("#gridTimetable tbody");
        tbody.innerHTML = "";
        data.forEach(entry => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="border px-4 py-2">${entry.time}</td>
            <td class="border px-4 py-2">${entry.monday}</td>
            <td class="border px-4 py-2">${entry.tuesday}</td>
            <td class="border px-4 py-2">${entry.wednesday}</td>
            <td class="border px-4 py-2">${entry.thursday}</td>
            <td class="border px-4 py-2">${entry.friday}</td>
            <td class="border px-4 py-2">${entry.saturday}</td>`;
          tbody.appendChild(row);
        });
      })
      .catch(err => console.error("Failed to load saved timetable:", err));
  };
</script>
</body>
</html>
